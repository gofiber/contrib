name: Release Drafter (v3 packages)

on:
    push:
        branches:
            - master
            - main
    workflow_dispatch:

jobs:
    changes:
        runs-on: ubuntu-latest
        permissions:
            pull-requests: read
        outputs:
            packages: ${{ github.event_name == 'workflow_dispatch' && steps.filter-setup.outputs.packages || steps.map-packages.outputs.packages || '[]' }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v5

            - name: Generate filters
              id: filter-setup
              shell: bash
              run: |
                  shopt -s nullglob
                  packages=(v3/*/)
                  package_names=()

                  if (( ${#packages[@]} == 0 )); then
                      echo "filters={}" >> "$GITHUB_OUTPUT"
                      echo "packages=[]" >> "$GITHUB_OUTPUT"
                      exit 0
                  fi

                  {
                      echo "filters<<EOF"
                      for pkg in "${packages[@]}"; do
                          name=${pkg#v3/}
                          name=${name%/}
                          path=${pkg%/}
                          printf "'%s': '%s/**'\n" "$name" "$path"
                          package_names+=("$path")
                      done
                      echo "EOF"
                  } >> "$GITHUB_OUTPUT"

                  if (( ${#package_names[@]} > 0 )); then
                      printf -v joined '"%s",' "${package_names[@]}"
                      joined=${joined%,}
                      echo "packages=[${joined}]" >> "$GITHUB_OUTPUT"
                  else
                      echo "packages=[]" >> "$GITHUB_OUTPUT"
                  fi

            - name: Filter changes
              id: filter
              uses: dorny/paths-filter@v3
              if: github.event_name != 'workflow_dispatch'
              with:
                  filters: ${{ steps.filter-setup.outputs.filters }}

            - name: Map package paths
              id: map-packages
              if: github.event_name != 'workflow_dispatch'
              env:
                  FILTER_PACKAGES: ${{ steps.filter.outputs.changes || '[]' }}
              run: |
                  python3 - <<'PY' >> "$GITHUB_OUTPUT"
                  import json
                  import os

                  packages = json.loads(os.environ["FILTER_PACKAGES"])
                  paths = [f"v3/{name}" for name in packages]
                  print(f"packages={json.dumps(paths)}")
                  PY

    release-drafter:
        needs: changes
        runs-on: ubuntu-latest
        timeout-minutes: 30
        if: needs.changes.outputs.packages != '[]'
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        strategy:
            matrix:
                package: ${{ fromJSON(needs.changes.outputs.packages || '[]') }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v5

            - name: Generate dynamic config from template
              id: generate-config
              run: |
                  package="${{ matrix.package }}"
                  directory="$package"
                  {
                      echo "config<<EOF"
                      sed -e "s|{{PACKAGE}}|$package|g" -e "s|{{DIRECTORY}}|$directory|g" .github/release-drafter-template.yml
                      echo "EOF"
                  } >> "$GITHUB_OUTPUT"

            - name: Use dynamic release-drafter configuration
              uses: ReneWerner87/release-drafter@6dec4ceb1fb86b6514f11a2e7a39e1dedce709d0
              with:
                  config: ${{ steps.generate-config.outputs.config }}
